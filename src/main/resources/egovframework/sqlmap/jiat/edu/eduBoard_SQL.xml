<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="eduBoard">

    <!-- 게시글 목록 조회 (전체) -->
    <select id="selectList" resultType="egovframework.com.cms.edu.model.EduBoardVO">
        SELECT 
            id,
            title,
            content,
            writer,
            created_at as createdAt,
            views,
            is_secret as isSecret,
            secret_password as secretPassword,
            is_notice as isNotice
        FROM edu_board
        ORDER BY 
            is_notice DESC,
        <choose>
            <when test="sortType == 'views'">
                views DESC, created_at DESC
            </when>
            <otherwise>
                created_at DESC
            </otherwise>
        </choose>
    </select>

    <!-- 게시글 목록 조회 (페이징) -->
    <select id="selectListWithPaging" parameterType="egovframework.com.cms.edu.model.PagingVO" 
            resultType="egovframework.com.cms.edu.model.EduBoardVO">
        SELECT 
            id,
            title,
            content,
            writer,
            created_at as createdAt,
            views,
            is_secret as isSecret,
            secret_password as secretPassword,
            is_notice as isNotice
        FROM edu_board
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND title LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'writer'">
                        AND writer LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <otherwise>
                        <!-- titleContent 또는 기본값 -->
                        AND (title LIKE CONCAT('%', #{searchKeyword}, '%') 
                             OR content LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>
        </where>
        ORDER BY 
            is_notice DESC,
        <choose>
            <when test="sortType == 'views'">
                views DESC, created_at DESC
            </when>
            <otherwise>
                created_at DESC
            </otherwise>
        </choose>
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 전체 게시글 수 조회 -->
    <select id="selectTotalCount" parameterType="egovframework.com.cms.edu.model.PagingVO" resultType="int">
        SELECT COUNT(*) 
        FROM edu_board
        <where>
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND title LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'writer'">
                        AND writer LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <otherwise>
                        <!-- titleContent 또는 기본값 -->
                        AND (title LIKE CONCAT('%', #{searchKeyword}, '%') 
                             OR content LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <!-- 게시글 상세 조회 -->
    <select id="selectDetail" parameterType="long" resultType="egovframework.com.cms.edu.model.EduBoardVO">
        SELECT 
            id,
            title,
            content,
            writer,
            created_at as createdAt,
            views,
            is_secret as isSecret,
            secret_password as secretPassword,
            is_notice as isNotice
        FROM edu_board
        WHERE id = #{id}
    </select>

    <!-- 게시글 등록 -->
    <insert id="insert" parameterType="egovframework.com.cms.edu.model.EduBoardVO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO edu_board (
            title,
            content,
            writer,
            created_at,
            views,
            is_secret,
            secret_password,
            is_notice
        ) VALUES (
            #{title},
            #{content},
            #{writer},
            NOW(),
            0,
            #{isSecret},
            #{secretPassword},
            #{isNotice}
        )
    </insert>

    <!-- 게시글 수정 -->
    <update id="update" parameterType="egovframework.com.cms.edu.model.EduBoardVO">
        UPDATE edu_board
        SET 
            title = #{title},
            content = #{content},
            writer = #{writer},
            is_secret = #{isSecret},
            secret_password = #{secretPassword},
            is_notice = #{isNotice}
        WHERE id = #{id}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="delete" parameterType="long">
        DELETE FROM edu_board
        WHERE id = #{id}
    </delete>

    <!-- 조회수 증가 -->
    <update id="updateViews" parameterType="long">
        UPDATE edu_board
        SET views = views + 1
        WHERE id = #{id}
    </update>

    <!-- 이전글 조회 -->
    <select id="selectPrevPost" parameterType="long" resultType="egovframework.com.cms.edu.model.EduBoardVO">
        SELECT 
            id,
            title,
            content,
            writer,
            created_at as createdAt,
            views,
            is_secret as isSecret,
            secret_password as secretPassword,
            is_notice as isNotice
        FROM edu_board
        WHERE id &lt; #{id}
        ORDER BY id DESC
        LIMIT 1
    </select>

    <!-- 다음글 조회 -->
    <select id="selectNextPost" parameterType="long" resultType="egovframework.com.cms.edu.model.EduBoardVO">
        SELECT 
            id,
            title,
            content,
            writer,
            created_at as createdAt,
            views,
            is_secret as isSecret,
            secret_password as secretPassword,
            is_notice as isNotice
        FROM edu_board
        WHERE id &gt; #{id}
        ORDER BY id ASC
        LIMIT 1
    </select>

    <!-- 파일 관련 쿼리들 -->
    
    <!-- 게시글의 첨부파일 목록 조회 -->
    <select id="selectFilesByBoardId" parameterType="long" resultType="egovframework.com.cms.edu.model.EduFileVO">
        SELECT 
            id,
            board_id as boardId,
            original_name as originalName,
            saved_name as savedName,
            file_path as filePath,
            file_size as fileSize,
            upload_date as uploadDate
        FROM edu_file
        WHERE board_id = #{boardId}
        ORDER BY upload_date ASC
    </select>

    <!-- 파일 정보 등록 -->
    <insert id="insertFile" parameterType="egovframework.com.cms.edu.model.EduFileVO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO edu_file (
            board_id,
            original_name,
            saved_name,
            file_path,
            file_size,
            upload_date
        ) VALUES (
            #{boardId},
            #{originalName},
            #{savedName},
            #{filePath},
            #{fileSize},
            NOW()
        )
    </insert>

    <!-- 파일 삭제 -->
    <delete id="deleteFile" parameterType="long">
        DELETE FROM edu_file
        WHERE id = #{fileId}
    </delete>

    <!-- 게시글의 모든 파일 삭제 -->
    <delete id="deleteFilesByBoardId" parameterType="long">
        DELETE FROM edu_file
        WHERE board_id = #{boardId}
    </delete>

    <!-- 파일 정보 조회 -->
    <select id="selectFileById" parameterType="long" resultType="egovframework.com.cms.edu.model.EduFileVO">
        SELECT 
            id,
            board_id as boardId,
            original_name as originalName,
            saved_name as savedName,
            file_path as filePath,
            file_size as fileSize,
            upload_date as uploadDate
        FROM edu_file
        WHERE id = #{fileId}
    </select>

</mapper>
